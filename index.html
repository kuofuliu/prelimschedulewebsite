<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KuofuPrelim</title>
  <style>
    :root { --bg:#0b0c10; --card:#12141b; --muted:#aab0c0; --text:#eef0f7; --border:#222636; --accent:#e8c547; }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:var(--bg); color:var(--text); }
    .wrap{ max-width:980px; margin:0 auto; padding:20px; }
    header{ display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:16px; }
    header .brand{ font-weight:800; letter-spacing:.2px; }
    header .brand span{ color:var(--accent); }
    .badge{ padding:6px 10px; border:1px solid var(--border); border-radius:999px; font-size:12px; color:var(--muted); }
    .badge.live{ color:#52c98f; border-color:#52c98f; }
    .badge.bad{ color:#ff6b6b; border-color:#ff6b6b; }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px; }
    .row{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media (max-width:800px){ .row{ grid-template-columns:1fr; } header{ flex-direction:column; align-items:flex-start; } }
    label{ display:block; font-size:12px; color:var(--muted); margin:10px 0 6px; }
    input, button{ width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:#0f1117; color:var(--text); font-size:14px; }
    input::placeholder{ color:#727a90; }
    button{ cursor:pointer; border-color:transparent; background:var(--accent); color:#141414; font-weight:800; }
    button.secondary{ background:#0f1117; border:1px solid var(--border); color:var(--text); font-weight:650; }
    .btnrow{ display:flex; gap:10px; margin-top:12px; }
    .btnrow > *{ flex:1; }
    .hint{ color:var(--muted); font-size:12px; margin-top:8px; line-height:1.35; }
    .toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:16px; background:#0f1117; border:1px solid var(--border); padding:10px 12px; border-radius:12px; color:var(--text); display:none; max-width:min(92vw,720px); }
    .screen{ display:none; }
    .screen.active{ display:block; }
    .mono{ font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace; }
    .dow{ display:flex; flex-wrap:wrap; gap:8px; margin-top:6px; }
    .chip{ display:inline-flex; align-items:center; gap:6px; padding:8px 10px; border-radius:999px; border:1px solid var(--border); background:#0f1117; color:var(--muted); font-size:13px; user-select:none; cursor:pointer; }
    .chip input{ width:auto; }
    .chip.on{ color:var(--text); border-color:rgba(232,197,71,0.6); }
    table{ width:100%; border-collapse:collapse; margin-top:12px; }
    th, td{ border:1px solid var(--border); padding:10px; text-align:center; font-size:13px; }
    th{ color:var(--muted); font-weight:750; }
    td{ cursor:pointer; position:relative; }
    .topline{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .pill{ padding:6px 10px; border:1px solid var(--border); border-radius:999px; font-size:12px; color:var(--muted); }
    .pill strong{ color:var(--text); font-weight:800; }
    .small{ font-size:12px; color:var(--muted); }

    /* mode selection */
    .modes{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-top:10px; }
    .modeBtn{ width:auto; padding:8px 10px; border-radius:999px; border:1px solid var(--border); background:#0f1117; color:var(--text); font-weight:650; }
    .modeBtn.active{ border-color:rgba(232,197,71,0.65); box-shadow:0 0 0 2px rgba(232,197,71,0.15) inset; }
    .dot{ display:inline-block; width:10px; height:10px; border-radius:999px; margin-right:8px; vertical-align:middle; }
    .dot.v{ background:#4aa3ff; }
    .dot.p{ background:#52c98f; }
    .dot.e{ background:#b38cff; }
    .dot.u{ background:#6b7280; }

    /* cell coloring for YOUR selections */
    td.sel-v{ background:rgba(74,163,255,0.18); border-color:rgba(74,163,255,0.55); }
    td.sel-p{ background:rgba(82,201,143,0.18); border-color:rgba(82,201,143,0.55); }
    td.sel-e{ background:rgba(179,140,255,0.18); border-color:rgba(179,140,255,0.55); }
    td.sel-u{ background:rgba(107,114,128,0.20); border-color:rgba(107,114,128,0.60); }

    .count{ position:absolute; top:6px; right:6px; font-size:12px; color:var(--muted); }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getDatabase, ref, set, get, onValue } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

    // Firebase config (KuofuPrelim)
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyA87AispmFcuHFHEwDAtRzEnMWbCIYtWA8",
      authDomain: "kuofuprelim.firebaseapp.com",
      databaseURL: "https://kuofuprelim-default-rtdb.firebaseio.com",
      projectId: "kuofuprelim",
      storageBucket: "kuofuprelim.firebasestorage.app",
      messagingSenderId: "515466008918",
      appId: "1:515466008918:web:f30c8a45e71578559e1ef7"
    };

    const $ = (id) => document.getElementById(id);
    const show = (screenId) => {
      for (const el of document.querySelectorAll(".screen")) el.classList.remove("active");
      $(screenId).classList.add("active");
    };
    const toast = (msg) => {
      const t = $("toast");
      t.textContent = msg;
      t.style.display = "block";
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(() => (t.style.display = "none"), 2600);
    };
    const uid = () => Math.random().toString(36).slice(2, 10);

    const setBadge = (text, state=null) => {
      const b = $("badge");
      b.textContent = text;
      b.classList.toggle("live", state === "live");
      b.classList.toggle("bad", state === "bad");
    };

    const dateRange = (from, to, weekdays) => {
      const dates = [];
      const wd = (Array.isArray(weekdays) && weekdays.length) ? new Set(weekdays.map(Number)) : null;
      let d = new Date(from + "T00:00:00");
      const end = new Date(to + "T00:00:00");
      while (d <= end) {
        if (!wd || wd.has(d.getDay())) dates.push(new Date(d));
        d.setDate(d.getDate() + 1);
      }
      return dates;
    };
    const fmtDate = (d) => d.toLocaleDateString(undefined, { weekday:"short", month:"short", day:"2-digit" });

    // time helpers (supports input type=time)
    const parseTime = (t) => {
      const [hh, mm] = (t || "").split(":").map(Number);
      if (!Number.isFinite(hh) || !Number.isFinite(mm)) return null;
      return hh * 60 + mm;
    };
    const labelTime = (mins) => {
      const hh = Math.floor(mins/60);
      const mm = mins%60;
      const ampm = hh >= 12 ? "PM" : "AM";
      const h12 = ((hh + 11) % 12) + 1;
      return `${h12}:${String(mm).padStart(2,"0")} ${ampm}`;
    };

    // Mode codes:
    // v = virtual only, p = in-person only, e = either, u = unavailable
    let activeMode = "e";
    const setActiveMode = (m) => {
      activeMode = m;
      for (const btn of document.querySelectorAll(".modeBtn")) {
        btn.classList.toggle("active", btn.dataset.mode === m);
      }
    };

    // Firebase init (no brittle "get(.info/connected)" test)
    let app, db;
    const initFirebase = () => {
      try {
        app = initializeApp(FIREBASE_CONFIG);
        db = getDatabase(app);

        // If init succeeds, config is valid
        setBadge("● Live", "live");

        // Optional: realtime connection state
        onValue(ref(db, ".info/connected"), (snap) => {
          const ok = !!snap.val();
          setBadge(ok ? "● Live" : "Connecting…", ok ? "live" : null);
        });
      } catch (e) {
        console.error(e);
        setBadge("⚠️ Not connected", "bad");
        toast("Firebase init failed. Check Console.");
      }
    };

    // App state
    let currentEvent = null;
    let myName = "";
    let mySelected = new Map(); // key -> mode

    const getSelectedWeekdays = () => {
      const boxes = Array.from(document.querySelectorAll('#dow input[type="checkbox"]'));
      return boxes.filter(b => b.checked).map(b => +b.value);
    };
    const syncChips = () => {
      const chips = Array.from(document.querySelectorAll("#dow .chip"));
      chips.forEach(ch => {
        const b = ch.querySelector("input");
        ch.classList.toggle("on", !!b.checked);
      });
    };

    const cellClassForMode = (m) => {
      if (m === "v") return "sel-v";
      if (m === "p") return "sel-p";
      if (m === "e") return "sel-e";
      if (m === "u") return "sel-u";
      return "";
    };

    const buildGrid = (ev, responses) => {
      const dates = dateRange(ev.from, ev.to, ev.weekdays);
      const start = ev.startMin;
      const end = ev.endMin;
      const step = 30; // minutes
      const slots = [];
      for (let m = start; m < end; m += step) slots.push(m);

      const tbl = $("grid");
      tbl.innerHTML = "";

      // header
      const thead = document.createElement("thead");
      const trh = document.createElement("tr");
      trh.appendChild(Object.assign(document.createElement("th"), { textContent: "" }));
      for (let j = 0; j < slots.length; j++) {
        const th = document.createElement("th");
        th.textContent = labelTime(slots[j]);
        trh.appendChild(th);
      }
      thead.appendChild(trh);
      tbl.appendChild(thead);

      // counts per cell (count anyone who is not unavailable)
      const countFor = (key) => {
        let c = 0;
        for (const sel of Object.values(responses || {})) {
          const v = sel?.[key];
          if (v && v !== "u") c++;
        }
        return c;
      };

      const tbody = document.createElement("tbody");
      for (let i = 0; i < dates.length; i++) {
        const tr = document.createElement("tr");
        const th = document.createElement("th");
        th.textContent = fmtDate(dates[i]);
        tr.appendChild(th);

        for (let j = 0; j < slots.length; j++) {
          const td = document.createElement("td");
          const key = `${i}-${j}`;
          td.dataset.key = key;

          // your selection
          const myMode = mySelected.get(key);
          if (myMode) td.classList.add(cellClassForMode(myMode));

          // count badge
          const c = countFor(key);
          if (c > 0) {
            const sp = document.createElement("span");
            sp.className = "count mono";
            sp.textContent = String(c);
            td.appendChild(sp);
          }

          td.addEventListener("click", async () => {
            if (!currentEvent) return;

            // clicking sets activeMode; clicking again on same mode clears it
            const prev = mySelected.get(key) || null;
            const next = (prev === activeMode) ? null : activeMode;

            // update local
            td.classList.remove("sel-v","sel-p","sel-e","sel-u");
            if (next) {
              mySelected.set(key, next);
              td.classList.add(cellClassForMode(next));
            } else {
              mySelected.delete(key);
            }

            // persist sparse map for me
            const obj = {};
            for (const [k, v] of mySelected.entries()) obj[k] = v;
            await set(ref(db, `events/${currentEvent.id}/responses/${myName}`), obj);
          });

          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      }
      tbl.appendChild(tbody);

      $("summary").textContent =
        `Days: ${dates.length} · Slots/day: ${slots.length} · Participants: ${Object.keys(responses||{}).length} · Count shows # available (not unavailable)`;
    };

    const enterEvent = async () => {
      const code = $("join-code").value.trim();
      const name = $("join-name").value.trim();
      if (!code) { toast("Enter event code"); return; }
      if (!name) { toast("Enter your name"); return; }

      myName = name;

      const metaSnap = await get(ref(db, `events/${code}/meta`));
      if (!metaSnap.exists()) { toast("Event not found"); return; }
      currentEvent = metaSnap.val();

      $("ev-title").textContent = currentEvent.name || "Event";
      $("ev-code").textContent = code;

      // load my selections
      const mine = await get(ref(db, `events/${code}/responses/${myName}`));
      mySelected = new Map();
      if (mine.exists()) {
        const obj = mine.val() || {};
        for (const [k,v] of Object.entries(obj)) mySelected.set(k, v);
      }

      // live updates
      onValue(ref(db, `events/${code}/responses`), (s) => {
        const responses = s.val() || {};
        const me = responses[myName] || {};
        mySelected = new Map(Object.entries(me));
        buildGrid(currentEvent, responses);
      });

      show("event");
      toast("Joined");
    };

    const createEvent = async () => {
      const name = $("new-name").value.trim();
      const from = $("new-from").value;
      const to   = $("new-to").value;
      const wds  = getSelectedWeekdays();
      const startMin = parseTime($("new-start").value);
      const endMin   = parseTime($("new-end").value);

      if (!name) { toast("Enter event name"); return; }
      if (!from || !to) { toast("Choose dates"); return; }
      if (from > to) { toast("From must be ≤ To"); return; }
      if (!wds.length) { toast("Select weekdays"); return; }
      if (startMin == null || endMin == null) { toast("Choose start/end time"); return; }
      if (startMin >= endMin) { toast("Start time must be before end time"); return; }

      const dates = dateRange(from, to, wds);
      if (!dates.length) { toast("No dates match weekdays"); return; }

      const id = uid();
      const meta = { id, name, from, to, weekdays: wds, startMin, endMin };
      await set(ref(db, `events/${id}/meta`), meta);

      const share = `${location.origin}${location.pathname}?event=${id}`;
      $("share").style.display = "block";
      $("share").innerHTML = `Share link: <span class="mono">${share}</span>`;
      navigator.clipboard?.writeText(share).catch(()=>{});

      $("join-code").value = id;
      toast("Created (link copied if allowed)");
    };

    const setup = () => {
      // mode buttons
      for (const btn of document.querySelectorAll(".modeBtn")) {
        btn.addEventListener("click", () => setActiveMode(btn.dataset.mode));
      }
      setActiveMode("e");

      syncChips();
      Array.from(document.querySelectorAll('#dow input[type="checkbox"]')).forEach(b => b.addEventListener("change", syncChips));

      $("btn-create").addEventListener("click", createEvent);
      $("btn-join").addEventListener("click", enterEvent);
      $("btn-back").addEventListener("click", () => { location.search = ""; show("home"); });

      // defaults
      const today = new Date();
      const to = new Date(today); to.setDate(to.getDate()+7);
      $("new-from").value = today.toISOString().slice(0,10);
      $("new-to").value = to.toISOString().slice(0,10);
      $("new-start").value = "09:00";
      $("new-end").value = "17:00";

      // Auto-fill join from shared link (?event=...)
      try {
        const params = new URLSearchParams(location.search);
        const ev = params.get("event");
        if (ev) $("join-code").value = ev;
      } catch(e) {}

      show("home");
      setBadge("Connecting…");
      initFirebase();
    };

    window.addEventListener("DOMContentLoaded", setup);
  </script>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">Kuofu<span>Prelim</span></div>
      <div id="badge" class="badge">Connecting…</div>
    </header>

    <div id="home" class="screen active">
      <div class="card">
        <div class="row">
          <div>
            <label>Event name</label>
            <input id="new-name" placeholder="e.g., Kuofu prelim scheduling" />
          </div>
          <div>
            <label>Weekdays</label>
            <div class="dow" id="dow">
              <label class="chip on"><input type="checkbox" value="1" checked>Mon</label>
              <label class="chip on"><input type="checkbox" value="2" checked>Tue</label>
              <label class="chip on"><input type="checkbox" value="3" checked>Wed</label>
              <label class="chip on"><input type="checkbox" value="4" checked>Thu</label>
              <label class="chip on"><input type="checkbox" value="5" checked>Fri</label>
              <label class="chip on"><input type="checkbox" value="6" checked>Sat</label>
              <label class="chip on"><input type="checkbox" value="0" checked>Sun</label>
            </div>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Date from</label>
            <input id="new-from" type="date" />
          </div>
          <div>
            <label>Date to</label>
            <input id="new-to" type="date" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Start time</label>
            <input id="new-start" type="time" step="1800" />
          </div>
          <div>
            <label>End time</label>
            <input id="new-end" type="time" step="1800" />
          </div>
        </div>

        <div class="btnrow">
          <button id="btn-create">Create event</button>
        </div>

        <div id="share" class="hint" style="display:none; margin-top:10px;"></div>

        <hr style="border:none; border-top:1px solid var(--border); margin:14px 0;" />

        <div class="row">
          <div>
            <label>Join (event code)</label>
            <input id="join-code" class="mono" placeholder="e.g., a1b2c3d4" />
          </div>
          <div>
            <label>Your name</label>
            <input id="join-name" placeholder="e.g., Mariel" />
          </div>
        </div>
        <div class="btnrow">
          <button id="btn-join" class="secondary">Join event</button>
        </div>

        <div class="hint">If creating/joining fails, verify Realtime Database rules are published and allow read/write.</div>
      </div>
    </div>

    <div id="event" class="screen">
      <div class="card">
        <div class="topline">
          <div class="pill"><strong id="ev-title"></strong></div>
          <div class="pill">Code: <span class="mono" id="ev-code"></span></div>
          <button id="btn-back" class="secondary" style="width:auto; padding:8px 10px;">Back</button>
        </div>

        <div class="modes" style="margin-top:10px;">
          <span class="small">Click mode, then click grid cells:</span>
          <button class="modeBtn active" data-mode="e"><span class="dot e"></span>Either</button>
          <button class="modeBtn" data-mode="v"><span class="dot v"></span>Virtual</button>
          <button class="modeBtn" data-mode="p"><span class="dot p"></span>In-person</button>
          <button class="modeBtn" data-mode="u"><span class="dot u"></span>Unavailable</button>
        </div>

        <div class="small" id="summary" style="margin-top:8px;"></div>
        <table id="grid"></table>
        <div class="hint">Click a cell to set your mode. Clicking again on the same mode clears it. Cell number = # people available (virtual/in-person/either).</div>
      </div>
    </div>

  </div>
  <div id="toast" class="toast"></div>
</body>
</html>
